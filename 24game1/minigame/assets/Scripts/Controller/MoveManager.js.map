{"version":3,"sources":["__temp/buildProcess/inlineFunctionProcess/Scripts/Controller/MoveManager.ts"],"names":[],"mappings":"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","file":"MoveManager.js","sourcesContent":["import engine from 'engine'\nimport PlayerController from './PlayerController'\nimport CameraController from './CameraController'\nimport PawnController from './PawnController';\nimport EventManager from '../event/EventManager';\nimport config from '../multiPlayer/config';\n\n\n\nconst VIEW = {\n    FIRSTVIEW: 0,\n    THIRDVIEW: 1\n};\n\n@engine.decorators.serialize(\"MoveManager\")\nexport default class MoveManager extends engine.Script{\n\n    private _viewMode: number = VIEW.THIRDVIEW;\n    public PlayerState: number = config.PlayerState.IDLE;\n\n    public playerController:PlayerController;\n    public pawnController:PawnController;\n\n    private dir:engine.Vector2=engine.Vector2.ZERO.clone();\n    private inputDir:engine.Vector2=engine.Vector2.ZERO.clone();\n\n    private frameMov:engine.Vector3=engine.Vector3.ZERO.clone();\n    private frameRot:engine.Vector3=engine.Vector3.ZERO.clone();\n    private rotSpeed:number;\n\n    private dest:engine.Vector3=this.entity.transform.position;\n    private destRot:engine.Vector3=this.entity.transform.euler;\n    private predictDest:engine.Vector3=this.dest;\n    private predictDestRot:engine.Vector3=this.destRot;\n\n\n    //cameraRotate记录【仅】由相机引起的旋转角度\n    private cameraRotate:number=0;\n\n\n    public onAwake()\n    {\n        this.initController();\n    }\n\n    public initController() {\n        this.playerController = this.getComponent<PlayerController>(PlayerController);\n        this.pawnController = this.getComponent<PawnController>(PawnController);\n    }\n\n    public characterMove(x:number,y:number, PlayerState:number){\n        this.PlayerState = config.PlayerState.MOVE;\n        let v3dir=engine.Vector3.createFromNumber(-x,0,y);\n        let rotateQuat;\n\n        rotateQuat = engine.Quaternion.fromEulerAngles(engine.Vector3.createFromNumber(0, \n            this.cameraRotate, 0));\n\n        v3dir=engine.Vector3.transformQuat(v3dir, rotateQuat);\n        this.dir.x=v3dir.x;\n        this.dir.y=v3dir.z;\n    }\n\n    public characterIdle(PlayerState:number){\n        this.PlayerState = config.PlayerState.IDLE;\n        this.dir= engine.Vector2.ZERO.clone();\n    }\n\n    public cameraRotateY(rotation:number){\n        //由于视角巡视累积的相机旋转角度\n        this.cameraRotate=(this.cameraRotate+rotation/50)%(2*Math.PI);\n        this.playerController.entity.transform.rotate(engine.Vector3.createFromNumber(0,rotation/50,0));\n    }\n\n    public switchView(){\n        switch (this._viewMode) {\n            case VIEW.FIRSTVIEW:\n                this._viewMode = VIEW.THIRDVIEW;\n                this.cameraRotate=this.entity.transform.euler.y;\n                break;\n            case VIEW.THIRDVIEW:\n                this._viewMode = VIEW.FIRSTVIEW;\n                this.cameraRotate=this.entity.transform.euler.y;\n                break;\n        }\n    }\n\n\n    public renderUpdate(dt:number){\n        switch(this.PlayerState<<1|this._viewMode)\n        {\n            case config.PlayerState.MOVE<<1|VIEW.FIRSTVIEW:\n                //Math.abs保证前进与后退，都有动画行为\n                this.pawnController.updateMoveAnime(this.inputDir.x,Math.abs(this.inputDir.y));\n                break;\n            case config.PlayerState.MOVE<<1|VIEW.THIRDVIEW:\n                this.pawnController.updateMoveAnime(this.inputDir.x,this.inputDir.y);\n                break;\n            case config.PlayerState.IDLE<<1|VIEW.FIRSTVIEW:\n                this.pawnController.updateIdleAnime();\n                break;\n            case config.PlayerState.IDLE<<1|VIEW.THIRDVIEW:\n                this.pawnController.updateIdleAnime();\n                break;\n        }\n\n        let position=this.entity.transform.position;\n        let euler=this.entity.transform.euler;\n\n        // if(this.predictDest.x!=position.x||this.predictDest.y!=position.y)\n        // {\n        //     let disVec=this.predictDest.add(this.entity.transform.position.scale(-1));\n        if(this.dest.x!=position.x||this.dest.y!=position.y)\n        {\n            let disVec=this.dest.add(this.entity.transform.position.scale(-1));\n            let dis=dt/(1/config.fps)*config.playerSpeed/1000*config.fps;\n            let percent=dis/(disVec.length());\n            if(percent<0)\n                percent=0;\n            if(percent>1)\n                percent=1;\n        \n          //  this.entity.transform.position=this.entity.transform.position.add(disVec.scale(percent));\n          this.playerController.characterController.move(disVec.scale(percent));\n        }\n\n        // if(this.predictDestRot.y!=euler.y)\n        // {\n        //     let disVec=this.predictDestRot.add(this.entity.transform.euler.scale(-1));\n        if(this.destRot.y!=euler.y)\n         {\n             let disVec=this.destRot.add(this.entity.transform.euler.scale(-1));\n            let dis=dt/(1/config.fps)*this.rotSpeed/1000*config.fps;\n            let percent=dis/(disVec.length());\n            if(percent<0)\n                percent=0;\n            if(percent>1)\n                percent=1;\n\n            this.entity.transform.euler=this.entity.transform.euler.add(disVec.scale(percent));\n        }\n    }\n\n    public logicUpdate(dt){\n        let v3dir= this.entity.transform.localMatrix.inverse().transformDirection(engine.Vector3.createFromNumber(\n        this.dir.x,0,this.dir.y)).normalize();\n        this.inputDir=engine.Vector2.createFromNumber(v3dir.x,v3dir.z);\n        \n        switch(this.PlayerState<<1|this._viewMode)\n        {\n            case config.PlayerState.MOVE<<1|VIEW.FIRSTVIEW:\n                //这里调用了全局坐标系下的移动方向\n                this.playerController.update1stMove(this.dir.x,this.dir.y,dt,this.frameMov);\n                this.dest=this.dest.add(this.frameMov);\n                break;\n            case config.PlayerState.MOVE<<1|VIEW.THIRDVIEW:\n                this.playerController.update3rdMove(dt,this.frameMov);\n                this.rotSpeed=this.playerController.update3rdRotate(this.inputDir.x,this.inputDir.y,dt,this.frameRot);\n                this.dest=this.dest.add(this.frameMov);\n                this.destRot=this.destRot.add(this.frameRot);\n                break;\n        }\n    }\n\n    public preditUpdate(dt){\n        let v3dir= this.entity.transform.localMatrix.inverse().transformDirection(engine.Vector3.createFromNumber(\n        this.dir.x,0,this.dir.y)).normalize();\n        this.inputDir=engine.Vector2.createFromNumber(v3dir.x,v3dir.z);\n        switch(this.PlayerState<<1|this._viewMode)\n        {\n            case config.PlayerState.MOVE<<1|VIEW.FIRSTVIEW:\n                //这里调用了全局坐标系下的移动方向\n                this.playerController.update1stMove(this.dir.x,this.dir.y,dt,this.frameMov);\n                this.predictDest=this.dest.add(this.frameMov);\n                break;\n            case config.PlayerState.MOVE<<1|VIEW.THIRDVIEW:\n                this.playerController.update3rdMove(dt,this.frameMov);\n                this.rotSpeed=this.playerController.update3rdRotate(this.inputDir.x,this.inputDir.y,dt,this.frameRot);\n                this.predictDest=this.dest.add(this.frameMov);\n                this.predictDestRot=this.destRot.add(this.frameRot);\n                break;\n        }\n    }\n\n\n   \n\n\n\n}\n\n   "]}